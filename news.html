<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Old Lottery Result Viewer</title>
<style>
body{
    font-family: Arial, sans-serif;
    background: #f5f7fb;
    margin:0;
    padding:0;
    display:flex;
    flex-direction:column;
    align-items:center;
}
header{
    width:100%;
    background:#1e3a8a;
    color:white;
    padding:15px 0;
    text-align:center;
    font-size:1.5em;
    font-weight:bold;
}
main{
    width:95%;
    max-width:900px;
    margin-top:20px;
    background:white;
    padding:20px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
h2{
    text-align:center;
    color:#1e3a8a;
}
.date-picker{
    text-align:center;
    margin-bottom:20px;
}
.date-picker input{
    padding:8px;
    font-size:1em;
}
.card{
    margin-bottom:20px;
    padding:15px;
    border-radius:8px;
    background:#eef2fb;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.card h3{
    margin:0 0 10px 0;
}
.pdf-frame{
    width:100%;
    height:500px;
    border:none;
    border-radius:10px;
    display:none;
}
.status{
    margin:10px 0;
    color:#555;
}
.refresh-btn{
    margin-right:10px;
    padding:8px 16px;
    background:#1e3a8a;
    color:white;
    border:none;
    border-radius:5px;
    cursor:pointer;
    text-decoration:none;
}
.refresh-btn:hover{
    background:#374bbb;
}
</style>
</head>
<body>

<header>ðŸŽ¯ Old Lottery Results</header>

<main>
    <h2>Select Date to View Result</h2>
    <div class="date-picker">
        <input type="date" id="resultDate">
        <button onclick="loadOldResults()">Load Result</button>
    </div>

    <div id="oldResults"></div>
</main>

<script>
const OLD_BASE_URL = "https://ldemo.dhankesari.com/oldresultsdownload.php?filename=";
const draws = [
    { title:"ðŸŒ… Morning", prefix:"MN" },
    { title:"â˜€ï¸ Day",     prefix:"DN" },
    { title:"ðŸŒ™ Night",   prefix:"EN" }
];

/* ===== Format date to DDMMYY ===== */
function fileCode(d){
    return String(d.getDate()).padStart(2,"0") +
           String(d.getMonth()+1).padStart(2,"0") +
           String(d.getFullYear()).slice(-2);
}

/* ===== PDF AUTO RETRY ===== */
function loadPDFWithRetry(iframe, status, retryBtn, downloadBtn, pdfUrl){
    let attempt=0, maxRetry=4, loaded=false, retryTimer=null;

    iframe.style.display="none";
    retryBtn.style.display="none";
    downloadBtn.style.display="none";

    status.textContent="Loading Result...";
    status.style.display="block";

    const loadOnce = () => {
        iframe.src = "https://docs.google.com/gview?embedded=true&url=" + encodeURIComponent(pdfUrl) + "&t=" + Date.now();
    };

    const tryLoad = () => {
        if(loaded) return;
        attempt++;
        loadOnce();

        retryTimer = setTimeout(() => {
            if(loaded) return;
            if(attempt>=maxRetry){
                status.textContent="Click Retry to load result";
                retryBtn.style.display="inline-block";
                downloadBtn.style.display="inline-block";
                return;
            }
            tryLoad();
        }, 5000);
    };

    iframe.onload = () => {
        if(loaded) return;
        loaded=true;
        clearTimeout(retryTimer);
        iframe.style.display="block";
        status.style.display="none";
        retryBtn.style.display="none";
        downloadBtn.style.display="inline-block";
    };

    retryBtn.onclick = () => {
        loaded=false; attempt=0;
        retryBtn.style.display="none";
        downloadBtn.style.display="none";
        status.textContent="Loading Result...";
        status.style.display="block";
        tryLoad();
    };

    tryLoad();
}

/* ===== MAIN OLD RESULTS ===== */
function loadOldResults(){
    const wrap = document.getElementById("oldResults");
    wrap.innerHTML="";

    const dateInput = document.getElementById("resultDate").value;
    if(!dateInput){
        alert("Please select a date!");
        return;
    }

    const selectedDate = new Date(dateInput);

    draws.forEach(draw=>{
        const card = document.createElement("div");
        card.className="card";
        card.innerHTML = `<h3>${draw.title} - ${selectedDate.toDateString()}</h3>`;

        const iframe = document.createElement("iframe");
        iframe.className="pdf-frame";

        const status = document.createElement("div");
        status.className="status";

        const retryBtn = document.createElement("button");
        retryBtn.className="refresh-btn";
        retryBtn.textContent="Retry";

        const downloadBtn = document.createElement("a");
        downloadBtn.className="refresh-btn";
        downloadBtn.textContent="Download PDF";
        downloadBtn.target="_blank";

        const pdfUrl = OLD_BASE_URL + draw.prefix + fileCode(selectedDate) + ".PDF";
        downloadBtn.href = pdfUrl;

        card.append(iframe, status, retryBtn, downloadBtn);
        wrap.appendChild(card);

        loadPDFWithRetry(iframe, status, retryBtn, downloadBtn, pdfUrl);
    });
}
</script>

</body>
</html>
